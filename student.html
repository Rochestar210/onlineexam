<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal - LIMKOKWING UNIVERSITY</title>
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
        <div class="header-top">
            <div class="logo">
                <div class="logo-box">
                    <span>LUCT</span>
                </div>
                <div class="logo-text">
                    <h1>LIMKOKWING UNIVERSITY</h1>
                    <p>OF CREATIVE TECHNOLOGY - LESOTHO</p>
                </div>
            </div>
            <div class="header-info">
                <p><a href="contact.html">Contact Us</a></p>
            </div>
            
            <!-- Hamburger Button -->
            <button class="hamburger-btn" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        
        <nav>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="admin.html">Admin</a></li>
                <li><a href="examiner.html">Examiner</a></li>
                <li><a href="student.html" class="active">Student</a></li>
            </ul>
        </nav>
    </div>
  </header>

  <!-- Student Portal -->
  <section class="auth">
    <div class="container">
      <div class="auth-container">
        <!-- Login Form -->
        <div class="form-section" id="studentLoginSection">
          <h2>Student Login</h2>
          <p style="text-align: center; margin-bottom: 2rem; color: #666;">
            Access your student dashboard
          </p>
          <form id="studentLoginForm" autocomplete="off">
            <div class="form-group">
              <label for="studentEmail">Email:</label>
              <input type="email" id="studentEmail" required placeholder="Enter your email" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="studentPassword">Password:</label>
              <input type="password" id="studentPassword" required placeholder="Enter your password" autocomplete="new-password">
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn-primary">Login as Student</button>
              <button type="button" id="showStudentRegister" class="btn-secondary">Create New Account</button>
              <a href="index.html" class="btn-secondary" style="text-decoration: none; text-align: center;">Back to Home</a>
            </div>
            <div class="forgot-password">
              <a href="#" id="forgotPasswordLink">Forgot Password?</a>
            </div>
          </form>
        </div>

        <!-- Registration Form -->
        <div class="form-section" id="studentRegisterSection" style="display:none;">
          <h2>Student Registration</h2>
          <p style="text-align: center; margin-bottom: 2rem; color: #666;">
            Create your student account
          </p>
          <form id="studentRegisterForm" autocomplete="off">
            <div class="form-group">
              <label for="regStudentName">Full Name:</label>
              <input type="text" id="regStudentName" required placeholder="Enter your full name" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="regStudentEmail">Email:</label>
              <input type="email" id="regStudentEmail" required placeholder="Enter your email" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="regStudentUsername">Username:</label>
              <input type="text" id="regStudentUsername" required placeholder="Choose a username" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="regStudentPassword">Password:</label>
              <input type="password" id="regStudentPassword" required placeholder="Create a password (min 6 characters)" autocomplete="new-password">
            </div>
            <div class="form-group">
              <label for="regStudentCourse">Course:</label>
              <select id="regStudentCourse" required autocomplete="off">
                <option value="">Select Your Course</option>
                <option value="bscbit">BSCBIT</option>
                <option value="bscit">BSCIT</option>
                <option value="bscsm">BSCSM</option>
                <option value="dit">DIT</option>
                <option value="dbit">DBIT</option>
                <option value="dmse">DMSE</option>
              </select>
            </div>
            <div class="form-buttons">
              <button type="submit" class="btn-primary">Register Account</button>
              <button type="button" id="backToStudentLogin" class="btn-secondary">Back to Login</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <script>
    // =============================================
    // FIREBASE CONFIGURATION
    // =============================================
    const firebaseConfig = {
      apiKey: "AIzaSyBe857kGYoLQJxmLFpUcPS8jZtWxkFYBlk",
      authDomain: "onlineexam-99eb5.firebaseapp.com",
      projectId: "onlineexam-99eb5",
      storageBucket: "onlineexam-99eb5.firebasestorage.app",
      messagingSenderId: "474888464500",
      appId: "1:474888464500:web:7414d4dbd34e4a88898921"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // =============================================
    // UTILITY FUNCTIONS
    // =============================================
    function showAlert(message, type = 'error') {
      // Remove existing alerts
      const existingAlerts = document.querySelectorAll('.custom-alert');
      existingAlerts.forEach(alert => alert.remove());

      // Create alert element
      const alertDiv = document.createElement('div');
      alertDiv.className = `custom-alert ${type}`;
      alertDiv.textContent = message;
      alertDiv.style.cssText = `
        padding: 12px 16px;
        margin: 1rem 0;
        border-radius: 6px;
        font-weight: 500;
        border: 1px solid;
      `;

      if (type === 'success') {
        alertDiv.style.background = '#d4edda';
        alertDiv.style.color = '#155724';
        alertDiv.style.borderColor = '#c3e6cb';
      } else {
        alertDiv.style.background = '#f8d7da';
        alertDiv.style.color = '#721c24';
        alertDiv.style.borderColor = '#f5c6cb';
      }

      // Insert at top of current form section
      const currentSection = document.getElementById('studentLoginSection').style.display !== 'none' 
        ? document.getElementById('studentLoginSection') 
        : document.getElementById('studentRegisterSection');
      
      const form = currentSection.querySelector('form');
      currentSection.insertBefore(alertDiv, form);

      // Auto remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePassword(password) {
      return password.length >= 6;
    }

    function clearForms() {
      document.getElementById('studentLoginForm').reset();
      document.getElementById('studentRegisterForm').reset();
    }

    function switchToLogin() {
      document.getElementById('studentRegisterSection').style.display = 'none';
      document.getElementById('studentLoginSection').style.display = 'block';
      clearForms();
    }

    function switchToRegister() {
      document.getElementById('studentLoginSection').style.display = 'none';
      document.getElementById('studentRegisterSection').style.display = 'block';
      clearForms();
    }

    // =============================================
    // EVENT LISTENERS SETUP
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up event listeners...');

      // Form toggle buttons
      document.getElementById('showStudentRegister').addEventListener('click', switchToRegister);
      document.getElementById('backToStudentLogin').addEventListener('click', switchToLogin);

      // Forgot password
      document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
        e.preventDefault();
        showForgotPassword();
      });

      // Form submissions
      document.getElementById('studentLoginForm').addEventListener('submit', handleLogin);
      document.getElementById('studentRegisterForm').addEventListener('submit', handleRegister);

      // Hamburger menu
      document.querySelector('.hamburger-btn').addEventListener('click', function() {
        const navMenu = document.querySelector('.nav-menu');
        navMenu.classList.toggle('active');
      });

      console.log('Event listeners setup complete');
    });

    // =============================================
    // LOGIN HANDLER
    // =============================================
    async function handleLogin(e) {
      e.preventDefault();

      const email = document.getElementById('studentEmail').value.trim();
      const password = document.getElementById('studentPassword').value;

      if (!email || !password) {
        showAlert('Please fill in both email and password');
        return;
      }

      if (!validateEmail(email)) {
        showAlert('Please enter a valid email address');
        return;
      }

      try {
        showAlert('Logging in...', 'success');

        // Sign in with Firebase Authentication
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const userId = userCredential.user.uid;

        // Get user data from Firestore
        const userDoc = await db.collection('users').doc(userId).get();
        
        if (!userDoc.exists) {
          showAlert('User data not found. Please contact administrator.');
          await auth.signOut();
          return;
        }

        const userData = userDoc.data();

        // Verify user role
        if (userData.role !== 'student') {
          showAlert('Access denied. This portal is for students only.');
          await auth.signOut();
          return;
        }

        // Store user data and redirect
        localStorage.setItem('currentUser', JSON.stringify({
          uid: userId,
          ...userData
        }));

        showAlert('Login successful! Redirecting to dashboard...', 'success');

        // Redirect to student dashboard
        setTimeout(() => {
          window.location.href = 'student-dashboard.html';
        }, 1500);

      } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'Login failed. ';
        if (error.code === 'auth/user-not-found') {
          errorMessage = 'No account found with this email. Please register first.';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address.';
        } else {
          errorMessage += error.message;
        }
        
        showAlert(errorMessage);
      }
    }

    // =============================================
    // REGISTRATION HANDLER
    // =============================================
    async function handleRegister(e) {
      e.preventDefault();

      const name = document.getElementById('regStudentName').value.trim();
      const email = document.getElementById('regStudentEmail').value.trim();
      const username = document.getElementById('regStudentUsername').value.trim();
      const password = document.getElementById('regStudentPassword').value;
      const course = document.getElementById('regStudentCourse').value;

      // Validation
      if (!name || !email || !username || !password || !course) {
        showAlert('Please fill in all fields');
        return;
      }

      if (!validateEmail(email)) {
        showAlert('Please enter a valid email address');
        return;
      }

      if (!validatePassword(password)) {
        showAlert('Password must be at least 6 characters long');
        return;
      }

      try {
        showAlert('Creating your account...', 'success');

        // Check if username already exists
        const usernameSnapshot = await db.collection('users')
          .where('username', '==', username)
          .get();
        
        if (!usernameSnapshot.empty) {
          showAlert('Username already exists. Please choose a different username.');
          return;
        }

        // Check if email already exists
        const emailSnapshot = await db.collection('users')
          .where('email', '==', email)
          .get();
        
        if (!emailSnapshot.empty) {
          showAlert('Email already registered. Please use a different email.');
          return;
        }

        // Create user in Firebase Authentication
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const userId = userCredential.user.uid;

        // Save user data to Firestore
        await db.collection('users').doc(userId).set({
          username: username,
          role: 'student',
          name: name,
          email: email,
          course: course,
          registrationDate: new Date().toISOString(),
          uid: userId
        });

        showAlert('Registration successful! You can now login.', 'success');
        
        // Switch to login form
        setTimeout(() => {
          switchToLogin();
        }, 2000);

      } catch (error) {
        console.error('Registration error:', error);
        
        let errorMessage = 'Registration failed. ';
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'Email is already registered. Please use a different email.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password is too weak. Please use a stronger password.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address.';
        } else {
          errorMessage += error.message;
        }
        
        showAlert(errorMessage);
      }
    }

    // =============================================
    // PASSWORD RESET
    // =============================================
    async function showForgotPassword() {
      const email = prompt('Please enter your registered email address:');
      if (!email) return;

      if (!validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }

      try {
        await auth.sendPasswordResetEmail(email);
        alert('Password reset email sent! Please check your inbox and follow the instructions.');
      } catch (error) {
        alert('Error sending reset email: ' + error.message);
      }
    }

  </script>
</body>
</html>